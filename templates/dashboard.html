{% extends "base.html" %}

{% block content %}
<div class="container-fluid mt-5 mb-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Dashboard</h2>
        <div>
            <label for="seletorData" class="form-label me-2">Selecione uma data:</label>
            <input type="text" id="seletorData" class="form-control" style="width: 200px; display: inline-block;" autocomplete="off">
        </div>
    </div>
    <p class="text-muted">Resumo das vendas: <strong id="dataExibicao">{{ data_hoje }}</strong></p>
    
    <!-- Cards de Métricas -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-left-success shadow h-100">
                <div class="card-body">
                    <div class="text-success font-weight-bold text-uppercase mb-1">Total Vendido</div>
                    <div class="h3 mb-0">R$ <span id="cardTotalVendido">{{ "%.2f"|format(total_vendido) }}</span></div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card border-left-primary shadow h-100">
                <div class="card-body">
                    <div class="text-primary font-weight-bold text-uppercase mb-1">Quantidade de Vendas</div>
                    <div class="h3 mb-0"><span id="cardQuantidadeVendas">{{ quantidade_vendas }}</span></div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card border-left-warning shadow h-100">
                <div class="card-body">
                    <div class="text-warning font-weight-bold text-uppercase mb-1">Lucro Total</div>
                    <div class="h3 mb-0">R$ <span id="cardLucroTotal">{{ "%.2f"|format(total_lucro) }}</span></div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card border-left-info shadow h-100">
                <div class="card-body">
                    <div class="text-info font-weight-bold text-uppercase mb-1">Ticket Médio</div>
                    <div class="h3 mb-0">R$ <span id="cardTicketMedio">{% if quantidade_vendas > 0 %}{{ "%.2f"|format(total_vendido / quantidade_vendas) }}{% else %}0.00{% endif %}</span></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Gráfico -->
    <div class="row">
        <div class="col-md-8">
            <div class="card shadow mb-4">
                <div class="card-header bg-light">
                    <h6 class="m-0 font-weight-bold text-dark">Vendas por Forma de Pagamento</h6>
                </div>
                <div class="card-body" style="height: 507px;">
                    <canvas id="graficoFormasPagamento" 
                            data-labels="{% for forma in pagamentos_por_forma.keys() %}{{ forma }}{% if not loop.last %},{% endif %}{% endfor %}"
                            data-valores="{% for valor in pagamentos_por_forma.values() %}{{ valor }}{% if not loop.last %},{% endif %}{% endfor %}">
                    </canvas>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card shadow mb-4">
                <div class="card-header bg-light">
                    <h6 class="m-0 font-weight-bold text-dark">Resumo de Formas</h6>
                </div>
                <div class="card-body">
                    <div id="resumoFormas"></div>
                </div>
            </div>
            
            <div class="card shadow mb-4">
                <div class="card-header bg-light">
                    <h6 class="m-0 font-weight-bold text-dark">Horários com Mais Vendas</h6>
                </div>
                <div class="card-body" style="height: 220px;">
                    <canvas id="graficoHorarios" 
                            data-labels="{% for hora, qtd in vendas_por_hora %}{{ hora }}h{% if not loop.last %},{% endif %}{% endfor %}"
                            data-valores="{% for hora, qtd in vendas_por_hora %}{{ qtd }}{% if not loop.last %},{% endif %}{% endfor %}">
                    </canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Dependências -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>
<script>
function criarGrafico(id, tipo, labelDataset, cores, usarPorcentagem=false, maxY=null, mostrarLegenda=true) {
  const canvas = document.getElementById(id);
  let labels = canvas.dataset.labels.split(',').map(l => l.trim()).filter(l => l);
  let valores = canvas.dataset.valores.split(',').map(Number).filter(v => !isNaN(v));

  let dados = valores;
  if (usarPorcentagem) {
    const total = valores.reduce((acc, v) => acc + (v || 0), 0);
    dados = valores.map(v => v !== null ? ((v / total) * 100).toFixed(2) : null);
  }

  return new Chart(canvas, {
    type: tipo,
    data: {
      labels: labels,
      datasets: [{
        label: labelDataset,
        data: dados,
        backgroundColor: cores || 'rgba(54,162,235,0.6)',
        borderColor: Array.isArray(cores) ? cores.map(() => '#fff') : '#fff',
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: mostrarLegenda
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              if (usarPorcentagem) {
                return context.label + ': ' + (context.raw !== null ? context.raw + '%' : 'Sem vendas');
              }
              return context.label + ': ' +  (context.raw !== null ? context.raw.toFixed() + ' Venda(s) ' : 'Sem vendas');
            }
          }
        }
      },
      scales: (tipo === 'bar' || tipo === 'line') ? {
        y: { beginAtZero: true, max: maxY || undefined }
      } : {}
    }
  });
}

// Inicialização do gráfico
const graficoFormasPagamento = criarGrafico('graficoFormasPagamento', 'doughnut', 'Formas de Pagamento',
  ['#28a745','#dc3545','#ffc107','#17a2b8','#6f42c1'], true);

// Gráfico de horários
const graficoHorarios = criarGrafico('graficoHorarios', 'bar', 'Quantidade de Vendas',
  'rgba(13, 125, 32, 0.6)', false, null, false);

// Resumo de formas
const canvas = document.getElementById('graficoFormasPagamento');
const labels = canvas.dataset.labels.split(',').map(l => l.trim()).filter(l => l);
const valores = canvas.dataset.valores.split(',').map(Number).filter(v => !isNaN(v));
const cores = ['#28a745','#dc3545','#ffc107','#17a2b8','#6f42c1'];

let html = '';
labels.forEach((forma, i) => {
    html += `
        <div class="mb-3">
            <div class="d-flex justify-content-between">
                <span class="font-weight-bold">${forma}</span>
                <span>R$ ${valores[i].toFixed(2)}</span>
            </div>
            <div class="progress" style="height: 8px;">
                <div class="progress-bar" style="width: ${(valores[i] / Math.max(...valores)) * 100}%; background-color: ${cores[i]}"></div>
            </div>
        </div>
    `;
});
document.getElementById('resumoFormas').innerHTML = html || '<p class="text-muted">Sem dados</p>';

// Seletor de data
document.addEventListener("DOMContentLoaded", function() {
    flatpickr("#seletorData", {
        dateFormat: "d/m/Y",
        locale: "pt",
        defaultDate: new Date(new Date().setDate(new Date().getDate() - 1)),
        months: ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"],
        weekdays: {
            shorthand: ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "Sab"],
            longhand: ["Domingo", "Segunda", "Terça", "Quarta", "Quinta", "Sexta", "Sábado"]
        },
        placeholder: "dd/mm/aaaa",
        onChange: async function(selectedDates, dateStr, instance) {
            if (!dateStr) return;
            
            // Converter dd/mm/yyyy para yyyy-mm-dd para a API
            const [dia, mes, ano] = dateStr.split('/');
            const dataApi = `${ano}-${mes}-${dia}`;
            
            const response = await fetch(`/dados/dashboard/${dataApi}`);
            const dados = response.ok ? await response.json() : null;
            
            if (!dados || dados.erro) {
                alert('Erro ao carregar dados');
                return;
            }
            
            // Atualizar cards
            document.getElementById('cardTotalVendido').innerText = dados.total_vendido.toFixed(2);
            document.getElementById('cardQuantidadeVendas').innerText = dados.quantidade_vendas;
            document.getElementById('cardLucroTotal').innerText = dados.total_lucro.toFixed(2);
            document.getElementById('cardTicketMedio').innerText = dados.ticket_medio.toFixed(2);
            document.getElementById('dataExibicao').innerText = dados.data;
            
            // Atualizar gráfico
            const formas = Object.keys(dados.pagamentos_por_forma);
            const valores_novo = Object.values(dados.pagamentos_por_forma);
            
            graficoFormasPagamento.data.labels = formas;
            graficoFormasPagamento.data.datasets[0].data = valores_novo;
            graficoFormasPagamento.update();
            
            // Atualizar gráfico de horários
            if (dados.vendas_por_hora) {
                const horas = Object.keys(dados.vendas_por_hora);
                const qtd_horas = Object.values(dados.vendas_por_hora);
                
                graficoHorarios.data.labels = horas.map(h => h + 'h');
                graficoHorarios.data.datasets[0].data = qtd_horas;
                graficoHorarios.update();
            }
            
            // Atualizar resumo
            const cores = ['#28a745','#dc3545','#ffc107','#17a2b8','#6f42c1'];
            let html_novo = '';
            formas.forEach((forma, i) => {
                html_novo += `
                    <div class="mb-3">
                        <div class="d-flex justify-content-between">
                            <span class="font-weight-bold">${forma}</span>
                            <span>R$ ${valores_novo[i].toFixed(2)}</span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar" style="width: ${(valores_novo[i] / Math.max(...valores_novo)) * 100}%; background-color: ${cores[i]}"></div>
                        </div>
                    </div>
                `;
            });
            document.getElementById('resumoFormas').innerHTML = html_novo || '<p class="text-muted">Sem dados</p>';
        }
    });
});
</script>
{% endblock %}